<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euman Security Scanner v3</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-elevated: #1e1e2a;
            --border: #2a2a3a;
            --border-light: #3a3a4a;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent: #7c9cff;
            --accent-dim: #4a6acc;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
            --critical: #dc2626;
            --info: #38bdf8;
            --purple: #a78bfa;
            --python: #3572A5;
            --c-lang: #555555;
            --terraform: #844fba;
            --kubernetes: #326ce5;
            --docker: #2496ed;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-area { flex: 1; overflow: auto; padding: 1rem; }

        /* Sidebar */
        .logo {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .logo h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--accent);
        }
        .logo span { font-size: 0.6rem; color: var(--text-muted); display: block; margin-top: 0.2rem; }
        .nav-section { padding: 0.75rem 0; }
        .nav-label {
            padding: 0.3rem 1rem;
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            border-left: 2px solid transparent;
        }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--bg-tertiary); color: var(--accent); border-left-color: var(--accent); }
        .nav-icon { width: 16px; text-align: center; }
        .nav-badge {
            margin-left: auto;
            background: var(--error);
            color: white;
            font-size: 0.55rem;
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }
        .nav-badge.warn { background: var(--warning); color: black; }
        .nav-badge.info { background: var(--info); }

        /* Header */
        .header-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .lang-toggle {
            display: flex;
            gap: 0.2rem;
            background: var(--bg-tertiary);
            padding: 0.15rem;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .lang-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
        }
        .lang-btn.active { color: white; }
        .lang-btn[data-lang="c"].active { background: var(--c-lang); }
        .lang-btn[data-lang="python"].active { background: var(--python); }
        .lang-btn[data-lang="terraform"].active { background: var(--terraform); }
        .lang-btn[data-lang="kubernetes"].active { background: var(--kubernetes); }
        .lang-btn[data-lang="docker"].active { background: var(--docker); }

        /* Buttons */
        .btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-dim); }

        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .card-header {
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 0.75rem; }
        .card-body.scroll { max-height: 400px; overflow-y: auto; }

        /* Metrics */
        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1;
        }
        .metric-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.3rem;
        }
        .metric-card.critical .metric-value { color: var(--critical); }
        .metric-card.high .metric-value { color: var(--error); }
        .metric-card.medium .metric-value { color: var(--warning); }
        .metric-card.low .metric-value { color: var(--success); }
        .metric-card.info .metric-value { color: var(--info); }

        /* Risk Score */
        .risk-score {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .risk-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .risk-circle.critical { background: rgba(220, 38, 38, 0.2); border: 3px solid var(--critical); color: var(--critical); }
        .risk-circle.high { background: rgba(248, 113, 113, 0.2); border: 3px solid var(--error); color: var(--error); }
        .risk-circle.medium { background: rgba(251, 191, 36, 0.2); border: 3px solid var(--warning); color: var(--warning); }
        .risk-circle.low { background: rgba(74, 222, 128, 0.2); border: 3px solid var(--success); color: var(--success); }
        .risk-details { flex: 1; }
        .risk-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.3rem; }
        .risk-subtitle { font-size: 0.75rem; color: var(--text-secondary); }

        /* Code editor */
        .code-editor {
            width: 100%;
            min-height: 300px;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            resize: vertical;
            line-height: 1.5;
        }
        .code-editor:focus { outline: none; border-color: var(--accent); }

        /* Findings */
        .finding-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        .finding-header {
            display: flex;
            align-items: center;
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            gap: 0.75rem;
        }
        .finding-header:hover { background: var(--bg-elevated); }
        .finding-severity {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .finding-severity.critical { background: var(--critical); color: white; }
        .finding-severity.high { background: var(--error); color: white; }
        .finding-severity.medium { background: var(--warning); color: black; }
        .finding-severity.low { background: var(--success); color: black; }
        .finding-title { flex: 1; font-size: 0.8rem; }
        .finding-gate {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--accent);
        }
        .finding-meta {
            font-size: 0.6rem;
            color: var(--text-muted);
        }
        .finding-body {
            display: none;
            padding: 0.75rem;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        .finding-item.expanded .finding-body { display: block; }
        .finding-code {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }
        .finding-tags { display: flex; gap: 0.3rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .tag.owasp { border-color: var(--purple); color: var(--purple); }
        .tag.cwe { border-color: var(--info); color: var(--info); }
        .tag.nist { border-color: var(--success); color: var(--success); }

        /* Attack Path */
        .attack-path {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
        .attack-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0;
        }
        .attack-step:not(:last-child)::after {
            content: '‚Üì';
            display: block;
            text-align: center;
            color: var(--text-muted);
            padding: 0.2rem 0;
        }
        .attack-node {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            font-size: 0.7rem;
            flex: 1;
        }
        .attack-node.source { border-color: var(--info); }
        .attack-node.sink { border-color: var(--error); }

        /* Secrets */
        .secret-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 0.4rem;
        }
        .secret-icon { font-size: 1rem; }
        .secret-info { flex: 1; }
        .secret-type { font-size: 0.75rem; font-weight: 600; }
        .secret-location { font-size: 0.65rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .secret-preview {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--error);
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        /* Function blocks */
        .func-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        .func-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .func-header:hover { background: var(--bg-elevated); }
        .func-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
        }
        .func-badges { display: flex; gap: 0.3rem; }
        .func-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem;
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
        }
        .func-body {
            display: none;
            border-top: 1px solid var(--border);
        }
        .func-block.expanded .func-body { display: block; }
        .func-code {
            background: var(--bg-primary);
            padding: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
        .code-line { display: flex; line-height: 1.6; }
        .line-num {
            color: var(--text-muted);
            min-width: 35px;
            text-align: right;
            padding-right: 10px;
            user-select: none;
        }
        .line-content { flex: 1; white-space: pre; }
        .line-finding { background: rgba(248, 113, 113, 0.15); }
        .line-secret { background: rgba(220, 38, 38, 0.2); }

        /* OWASP Breakdown */
        .owasp-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .owasp-item:last-child { border-bottom: none; }
        .owasp-rank {
            width: 28px;
            height: 28px;
            background: var(--purple);
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
        }
        .owasp-info { flex: 1; }
        .owasp-name { font-size: 0.75rem; font-weight: 600; }
        .owasp-desc { font-size: 0.65rem; color: var(--text-muted); }
        .owasp-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Data Flow */
        .dataflow-container {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1rem;
        }
        .dataflow-path {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }
        .dataflow-node {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
        }
        .dataflow-node.tainted { border-color: var(--error); color: var(--error); }
        .dataflow-arrow { color: var(--text-muted); }

        /* Export */
        .export-options { display: flex; gap: 0.5rem; }

        /* Tabs */
        .tab-bar {
            display: flex;
            gap: 0.2rem;
            background: var(--bg-tertiary);
            padding: 0.3rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .tab-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { background: var(--bg-primary); color: var(--accent); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        .empty-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar { width: 60px; }
            .nav-label, .nav-item span:not(.nav-icon):not(.nav-badge) { display: none; }
            .nav-item { justify-content: center; padding: 0.75rem; }
            .logo h1 { font-size: 0.7rem; }
            .logo span { display: none; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>EUMAN</h1>
                <span>Security Scanner v3</span>
            </div>
            <div class="nav-section">
                <div class="nav-label">Analysis</div>
                <div class="nav-item active" onclick="showView('dashboard')">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showView('scan')">
                    <span class="nav-icon">üîç</span>
                    <span>Scan Code</span>
                </div>
                <div class="nav-item" onclick="showView('findings')">
                    <span class="nav-icon">‚ö†Ô∏è</span>
                    <span>Findings</span>
                    <span class="nav-badge" id="nav-findings-count">0</span>
                </div>
                <div class="nav-item" onclick="showView('secrets')">
                    <span class="nav-icon">üîë</span>
                    <span>Secrets</span>
                    <span class="nav-badge" id="nav-secrets-count">0</span>
                </div>
                <div class="nav-item" onclick="showView('dataflow')">
                    <span class="nav-icon">üîÄ</span>
                    <span>Data Flow</span>
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Tools</div>
                <div class="nav-item" onclick="showView('composer')">
                    <span class="nav-icon">‚ö°</span>
                    <span>ExcLisp</span>
                </div>
                <div class="nav-item" onclick="showView('reference')">
                    <span class="nav-icon">üìñ</span>
                    <span>Reference</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-title" id="view-title">Dashboard</div>
                <div class="header-actions">
                    <div class="lang-toggle">
                        <button class="lang-btn active" data-lang="c" onclick="setLang('c')">C</button>
                        <button class="lang-btn" data-lang="python" onclick="setLang('python')">PY</button>
                        <button class="lang-btn" data-lang="terraform" onclick="setLang('terraform')">TF</button>
                        <button class="lang-btn" data-lang="kubernetes" onclick="setLang('kubernetes')">K8s</button>
                        <button class="lang-btn" data-lang="docker" onclick="setLang('docker')">Docker</button>
                    </div>
                    <button class="btn" onclick="exportSARIF()">Export SARIF</button>
                    <button class="btn" onclick="exportJSON()">Export JSON</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard View -->
                <div class="view active" id="view-dashboard">
                    <div class="risk-score" id="risk-score">
                        <div class="risk-circle low" id="risk-circle">0</div>
                        <div class="risk-details">
                            <div class="risk-title">Risk Score</div>
                            <div class="risk-subtitle" id="risk-subtitle">No code scanned yet</div>
                        </div>
                    </div>

                    <div class="grid-4" style="margin-bottom: 1rem;">
                        <div class="metric-card critical">
                            <div class="metric-value" id="metric-critical">0</div>
                            <div class="metric-label">Critical</div>
                        </div>
                        <div class="metric-card high">
                            <div class="metric-value" id="metric-high">0</div>
                            <div class="metric-label">High</div>
                        </div>
                        <div class="metric-card medium">
                            <div class="metric-value" id="metric-medium">0</div>
                            <div class="metric-label">Medium</div>
                        </div>
                        <div class="metric-card low">
                            <div class="metric-value" id="metric-low">0</div>
                            <div class="metric-label">Low</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">OWASP Top 10 Coverage</div>
                            <div class="card-body scroll" id="owasp-breakdown">
                                <div class="empty-state">
                                    <div class="empty-icon">üõ°Ô∏è</div>
                                    <div>Scan code to see OWASP coverage</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">Finding Categories</div>
                            <div class="card-body scroll" id="category-breakdown">
                                <div class="empty-state">
                                    <div class="empty-icon">üìä</div>
                                    <div>Scan code to see categories</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scan View -->
                <div class="view" id="view-scan">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <span id="scan-lang-label">C Source Code</span>
                                <button class="btn" onclick="pasteCode()">Paste</button>
                            </div>
                            <div class="card-body">
                                <textarea class="code-editor" id="code-input" placeholder="// Paste code here..."></textarea>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <button class="btn btn-primary" onclick="analyze()" style="flex: 1;">üîç Analyze</button>
                                    <button class="btn" onclick="clearCode()">Clear</button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                Functions
                                <span style="font-size: 0.55rem; color: var(--text-muted);" id="func-count"></span>
                            </div>
                            <div class="card-body scroll" id="functions-panel">
                                <div class="empty-state">
                                    <div class="empty-icon">üìÅ</div>
                                    <div>Functions will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Findings View -->
                <div class="view" id="view-findings">
                    <div class="tab-bar">
                        <button class="tab-btn active" onclick="filterFindings('all')">All</button>
                        <button class="tab-btn" onclick="filterFindings('critical')">Critical</button>
                        <button class="tab-btn" onclick="filterFindings('high')">High</button>
                        <button class="tab-btn" onclick="filterFindings('medium')">Medium</button>
                        <button class="tab-btn" onclick="filterFindings('low')">Low</button>
                    </div>
                    <div id="findings-list">
                        <div class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <div>No findings yet. Scan some code!</div>
                        </div>
                    </div>
                </div>

                <!-- Secrets View -->
                <div class="view" id="view-secrets">
                    <div class="card">
                        <div class="card-header">Detected Secrets</div>
                        <div class="card-body" id="secrets-list">
                            <div class="empty-state">
                                <div class="empty-icon">üîê</div>
                                <div>No secrets detected</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Flow View -->
                <div class="view" id="view-dataflow">
                    <div class="card">
                        <div class="card-header">Taint Analysis - Data Flow Paths</div>
                        <div class="card-body" id="dataflow-list">
                            <div class="empty-state">
                                <div class="empty-icon">üîÄ</div>
                                <div>Data flow analysis will appear here</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ExcLisp Composer View -->
                <div class="view" id="view-composer">
                    <div class="grid-3">
                        <div class="card">
                            <div class="card-header">Build Command</div>
                            <div class="card-body">
                                <label style="font-size: 0.65rem; color: var(--text-muted);">Authority</label>
                                <select id="auth-select" onchange="updateCommand()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                    <option value="AI">AI</option>
                                    <option value="HUMAN">HUMAN</option>
                                    <option value="SYSTEM">SYSTEM</option>
                                </select>

                                <label style="font-size: 0.65rem; color: var(--text-muted);">Domain</label>
                                <select id="domain-select" onchange="updateCommand()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                    <option value="security">security</option>
                                    <option value="memory">memory</option>
                                    <option value="bounds">bounds</option>
                                    <option value="injection">injection</option>
                                    <option value="crypto">crypto</option>
                                </select>

                                <label style="font-size: 0.65rem; color: var(--text-muted);">Operation</label>
                                <select id="op-select" onchange="updateCommand()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                    <option value="ANALYZE">ANALYZE</option>
                                    <option value="FIX">FIX</option>
                                    <option value="PROTECT">PROTECT</option>
                                    <option value="VALIDATE">VALIDATE</option>
                                </select>

                                <label style="font-size: 0.65rem; color: var(--text-muted);">Gate</label>
                                <select id="gate-select" onchange="updateCommand()" style="width: 100%; margin-bottom: 0.5rem; padding: 0.4rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.75rem;">
                                    <option value="">-- none --</option>
                                    <option value="UAF-001">UAF-001</option>
                                    <option value="BOF-002">BOF-002</option>
                                    <option value="INT-002">INT-002</option>
                                    <option value="INJ-001">INJ-001</option>
                                    <option value="INJ-003">INJ-003</option>
                                    <option value="SEC-001">SEC-001</option>
                                </select>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                Command Preview
                                <button class="btn" onclick="copyCommand()">Copy</button>
                            </div>
                            <div class="card-body">
                                <div id="command-preview" style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; min-height: 80px;">
                                    <span style="color: #f472b6;">{AI}</span><span style="color: #60a5fa;">::security</span><span style="color: #4ade80;">(ANALYZE)</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">Quick Commands</div>
                            <div class="card-body scroll">
                                <div class="quick-cmd" onclick="loadQuick('uaf')">{AI}::memory(FIX)[UAF-001]</div>
                                <div class="quick-cmd" onclick="loadQuick('bounds')">{AI}::bounds(PROTECT)[BOF-002]</div>
                                <div class="quick-cmd" onclick="loadQuick('sql')">{AI}::injection(FIX)[INJ-003]</div>
                                <div class="quick-cmd" onclick="loadQuick('secrets')">{SYSTEM}::security(DENY)[SEC-001]</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reference View -->
                <div class="view" id="view-reference">
                    <div class="grid-3">
                        <div class="card">
                            <div class="card-header">C / Memory Safety Gates</div>
                            <div class="card-body scroll" id="c-gates-ref"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">Python / Injection Gates</div>
                            <div class="card-body scroll" id="py-gates-ref"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">IaC / Config Gates</div>
                            <div class="card-body scroll" id="iac-gates-ref"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .quick-cmd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent);
            cursor: pointer;
        }
        .quick-cmd:hover { border-color: var(--accent); }
    </style>

    <script>
        // ============================================================
        // SECURITY GATES
        // ============================================================
        const gates = {
            c: {
                'UAF-001': { desc: 'Use-after-free', cwe: 'CWE-416', owasp: 'A03', nist: 'SI-16', severity: 'CRITICAL', patterns: ['free('] },
                'DF-001': { desc: 'Double-free', cwe: 'CWE-415', owasp: 'A03', nist: 'SI-16', severity: 'CRITICAL', patterns: ['free('] },
                'BOF-001': { desc: 'Stack buffer overflow', cwe: 'CWE-121', owasp: 'A03', nist: 'SI-16', severity: 'CRITICAL', patterns: ['strcpy(', 'strcat(', 'gets(', 'sprintf('] },
                'BOF-002': { desc: 'Out-of-bounds access', cwe: 'CWE-125', owasp: 'A03', nist: 'SI-16', severity: 'HIGH', patterns: ['['] },
                'NULL-001': { desc: 'Null dereference', cwe: 'CWE-476', owasp: 'A03', nist: 'SI-16', severity: 'HIGH', patterns: ['!ptr', '== NULL'] },
                'NULL-002': { desc: 'Unchecked allocation', cwe: 'CWE-476', owasp: 'A03', nist: 'SI-16', severity: 'MEDIUM', patterns: ['malloc(', 'calloc('] },
                'INT-001': { desc: 'Integer overflow in allocation', cwe: 'CWE-190', owasp: 'A03', nist: 'SI-16', severity: 'HIGH', patterns: ['* sizeof'] },
                'INT-002': { desc: 'Integer overflow', cwe: 'CWE-190', owasp: 'A03', nist: 'SI-16', severity: 'MEDIUM', patterns: ['++', '+='] },
                'FMT-001': { desc: 'Format string vulnerability', cwe: 'CWE-134', owasp: 'A03', nist: 'SI-10', severity: 'CRITICAL', patterns: ['printf(user', 'sprintf(buf, user'] }
            },
            python: {
                'INJ-001': { desc: 'Code injection (eval/exec)', cwe: 'CWE-94', owasp: 'A03', nist: 'SI-10', severity: 'CRITICAL', patterns: ['eval(', 'exec('] },
                'INJ-002': { desc: 'Command injection', cwe: 'CWE-78', owasp: 'A03', nist: 'SI-10', severity: 'CRITICAL', patterns: ['os.system(', 'shell=True'] },
                'INJ-003': { desc: 'SQL injection', cwe: 'CWE-89', owasp: 'A03', nist: 'SI-10', severity: 'CRITICAL', patterns: ['execute(', '.format(', "f'SELECT", 'f"SELECT'] },
                'DESER-001': { desc: 'Unsafe deserialization', cwe: 'CWE-502', owasp: 'A08', nist: 'SI-10', severity: 'CRITICAL', patterns: ['pickle.load', 'yaml.load('] },
                'PATH-001': { desc: 'Path traversal', cwe: 'CWE-22', owasp: 'A01', nist: 'AC-3', severity: 'HIGH', patterns: ['open(', '../'] },
                'CRYPT-001': { desc: 'Weak cryptography', cwe: 'CWE-327', owasp: 'A02', nist: 'SC-13', severity: 'MEDIUM', patterns: ['md5(', 'sha1('] },
                'CRYPT-002': { desc: 'Insecure random', cwe: 'CWE-330', owasp: 'A02', nist: 'SC-13', severity: 'MEDIUM', patterns: ['random.randint', 'random.choice'] },
                'SSRF-001': { desc: 'Server-side request forgery', cwe: 'CWE-918', owasp: 'A10', nist: 'AC-3', severity: 'HIGH', patterns: ['requests.get(', 'urllib'] }
            },
            terraform: {
                'TF-001': { desc: 'Public S3 bucket', cwe: 'CWE-284', owasp: 'A01', nist: 'AC-3', severity: 'CRITICAL', patterns: ['acl = "public-read"', 'acl = "public-read-write"'] },
                'TF-002': { desc: 'Unencrypted storage', cwe: 'CWE-311', owasp: 'A02', nist: 'SC-13', severity: 'HIGH', patterns: ['encrypted = false'] },
                'TF-003': { desc: 'Overly permissive IAM', cwe: 'CWE-250', owasp: 'A01', nist: 'AC-6', severity: 'CRITICAL', patterns: ['"Action": "*"', '"Resource": "*"', 'effect = "Allow"'] },
                'TF-004': { desc: 'Missing logging', cwe: 'CWE-778', owasp: 'A09', nist: 'AU-2', severity: 'MEDIUM', patterns: ['logging {', 'access_logs'] },
                'TF-005': { desc: 'Open security group', cwe: 'CWE-284', owasp: 'A01', nist: 'AC-3', severity: 'CRITICAL', patterns: ['0.0.0.0/0', '::/0', 'cidr_blocks = ["0.0.0.0/0"]'] }
            },
            kubernetes: {
                'K8S-001': { desc: 'Privileged container', cwe: 'CWE-250', owasp: 'A01', nist: 'AC-6', severity: 'CRITICAL', patterns: ['privileged: true'] },
                'K8S-002': { desc: 'Run as root', cwe: 'CWE-250', owasp: 'A01', nist: 'AC-6', severity: 'HIGH', patterns: ['runAsUser: 0', 'runAsNonRoot: false'] },
                'K8S-003': { desc: 'Host network enabled', cwe: 'CWE-284', owasp: 'A01', nist: 'AC-3', severity: 'HIGH', patterns: ['hostNetwork: true'] },
                'K8S-004': { desc: 'No resource limits', cwe: 'CWE-400', owasp: 'A05', nist: 'SC-5', severity: 'MEDIUM', patterns: ['resources:'] },
                'K8S-005': { desc: 'Secret in env var', cwe: 'CWE-798', owasp: 'A07', nist: 'IA-5', severity: 'HIGH', patterns: ['valueFrom:', 'secretKeyRef:'] }
            },
            docker: {
                'DOCKER-001': { desc: 'Run as root', cwe: 'CWE-250', owasp: 'A01', nist: 'AC-6', severity: 'HIGH', patterns: ['USER root', 'FROM.*:latest'] },
                'DOCKER-002': { desc: 'Latest tag used', cwe: 'CWE-829', owasp: 'A06', nist: 'CM-7', severity: 'MEDIUM', patterns: [':latest'] },
                'DOCKER-003': { desc: 'ADD instead of COPY', cwe: 'CWE-829', owasp: 'A08', nist: 'SI-10', severity: 'LOW', patterns: ['ADD http', 'ADD *.tar'] },
                'DOCKER-004': { desc: 'Hardcoded secret', cwe: 'CWE-798', owasp: 'A07', nist: 'IA-5', severity: 'CRITICAL', patterns: ['ENV.*PASSWORD', 'ENV.*SECRET', 'ENV.*KEY='] }
            }
        };

        // Secret patterns
        const secretPatterns = [
            { type: 'AWS Access Key', pattern: /AKIA[0-9A-Z]{16}/g, severity: 'CRITICAL' },
            { type: 'AWS Secret Key', pattern: /[A-Za-z0-9/+=]{40}/g, severity: 'CRITICAL' },
            { type: 'GitHub Token', pattern: /gh[ps]_[A-Za-z0-9_]{36,}/g, severity: 'CRITICAL' },
            { type: 'Generic API Key', pattern: /api[_-]?key['":\s]*['"]?[A-Za-z0-9_\-]{20,}/gi, severity: 'HIGH' },
            { type: 'Password in Code', pattern: /password['":\s]*['"]?[A-Za-z0-9!@#$%^&*]{8,}/gi, severity: 'CRITICAL' },
            { type: 'Private Key', pattern: /-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/g, severity: 'CRITICAL' },
            { type: 'JWT Token', pattern: /eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+/g, severity: 'HIGH' },
            { type: 'Slack Token', pattern: /xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}/g, severity: 'HIGH' },
            { type: 'Generic Secret', pattern: /secret['":\s]*['"]?[A-Za-z0-9_\-]{16,}/gi, severity: 'HIGH' }
        ];

        // OWASP Top 10 2021
        const owaspTop10 = {
            'A01': { name: 'Broken Access Control', desc: 'Restrictions on authenticated users' },
            'A02': { name: 'Cryptographic Failures', desc: 'Crypto-related vulnerabilities' },
            'A03': { name: 'Injection', desc: 'SQL, NoSQL, OS, LDAP injection' },
            'A04': { name: 'Insecure Design', desc: 'Missing or ineffective controls' },
            'A05': { name: 'Security Misconfiguration', desc: 'Improper configuration' },
            'A06': { name: 'Vulnerable Components', desc: 'Using known vulnerable components' },
            'A07': { name: 'Auth Failures', desc: 'Authentication and session issues' },
            'A08': { name: 'Data Integrity Failures', desc: 'Insecure deserialization' },
            'A09': { name: 'Logging Failures', desc: 'Insufficient logging and monitoring' },
            'A10': { name: 'SSRF', desc: 'Server-Side Request Forgery' }
        };

        // State
        let currentLang = 'c';
        let currentView = 'dashboard';
        let analysisResults = { findings: [], secrets: [], functions: [], dataflows: [] };

        // ============================================================
        // NAVIGATION
        // ============================================================
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            event?.target?.closest('.nav-item')?.classList.add('active');
            
            const titles = {
                dashboard: 'Dashboard',
                scan: 'Scan Code',
                findings: 'Security Findings',
                secrets: 'Secrets Detection',
                dataflow: 'Data Flow Analysis',
                composer: 'ExcLisp Composer',
                reference: 'Gate Reference'
            };
            document.getElementById('view-title').textContent = titles[viewId] || viewId;
            currentView = viewId;
        }

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.lang-btn[data-lang="${lang}"]`).classList.add('active');
            
            const labels = { c: 'C Source Code', python: 'Python Code', terraform: 'Terraform', kubernetes: 'Kubernetes YAML', docker: 'Dockerfile' };
            document.getElementById('scan-lang-label').textContent = labels[lang];
            
            const placeholders = {
                c: '// Paste C code here...',
                python: '# Paste Python code here...',
                terraform: '# Paste Terraform here...',
                kubernetes: '# Paste K8s YAML here...',
                docker: '# Paste Dockerfile here...'
            };
            document.getElementById('code-input').placeholder = placeholders[lang];
        }

        // ============================================================
        // ANALYSIS ENGINE
        // ============================================================
        function analyze() {
            const code = document.getElementById('code-input').value;
            if (!code.trim()) return;

            const findings = [];
            const secrets = [];
            const dataflows = [];
            const lines = code.split('\n');

            // Detect secrets
            secretPatterns.forEach(sp => {
                let match;
                const regex = new RegExp(sp.pattern.source, sp.pattern.flags);
                lines.forEach((line, idx) => {
                    while ((match = regex.exec(line)) !== null) {
                        secrets.push({
                            type: sp.type,
                            severity: sp.severity,
                            line: idx + 1,
                            preview: match[0].substring(0, 20) + '...',
                            code: line.trim()
                        });
                    }
                });
            });

            // Detect vulnerabilities
            const langGates = gates[currentLang] || gates.c;
            lines.forEach((line, idx) => {
                const lineNum = idx + 1;
                const trimmed = line.trim();
                
                // Skip comments
                if (trimmed.startsWith('//') || trimmed.startsWith('#') || trimmed.startsWith('/*')) return;

                for (const [gateId, gate] of Object.entries(langGates)) {
                    for (const pattern of gate.patterns) {
                        if (line.includes(pattern)) {
                            // Check for safe idioms
                            let severity = gate.severity;
                            const context = lines.slice(Math.max(0, idx - 5), Math.min(lines.length, idx + 5)).join('\n');
                            
                            if (gateId === 'BOF-002' && /if\s*\([^)]*</.test(context)) severity = 'LOW';
                            if (gateId === 'NULL-002' && /if\s*\(\s*!?\w+\s*\)/.test(context)) severity = 'LOW';
                            if (gateId === 'INJ-003' && /execute\s*\([^,]+,\s*[\[\(]/.test(line)) severity = 'LOW';

                            findings.push({
                                id: `${gateId}-${lineNum}`,
                                gate: gateId,
                                desc: gate.desc,
                                cwe: gate.cwe,
                                owasp: gate.owasp,
                                nist: gate.nist,
                                severity: severity,
                                line: lineNum,
                                code: trimmed.substring(0, 80)
                            });
                            break;
                        }
                    }
                }
            });

            // Simple data flow detection
            const sources = ['input(', 'request.', 'argv', 'getenv', 'fread', 'recv('];
            const sinks = ['execute(', 'system(', 'eval(', 'exec(', 'printf(', 'strcpy('];
            
            sources.forEach(source => {
                lines.forEach((line, idx) => {
                    if (line.includes(source)) {
                        sinks.forEach(sink => {
                            for (let i = idx; i < Math.min(idx + 20, lines.length); i++) {
                                if (lines[i].includes(sink)) {
                                    dataflows.push({
                                        source: { line: idx + 1, code: line.trim(), type: source },
                                        sink: { line: i + 1, code: lines[i].trim(), type: sink }
                                    });
                                }
                            }
                        });
                    }
                });
            });

            // Parse functions
            const functions = parseFunctions(code);

            analysisResults = { findings, secrets, dataflows, functions };
            updateUI();
        }

        function parseFunctions(code) {
            const functions = [];
            const lines = code.split('\n');
            
            if (currentLang === 'c') {
                const funcRegex = /^[\w\s\*]+\s+(\w+)\s*\([^)]*\)\s*\{?$/;
                let i = 0;
                while (i < lines.length) {
                    const match = lines[i].match(funcRegex);
                    if (match) {
                        const name = match[1];
                        const start = i;
                        let braceCount = 0;
                        let started = false;
                        let funcLines = [];
                        
                        while (i < lines.length) {
                            funcLines.push(lines[i]);
                            for (const ch of lines[i]) {
                                if (ch === '{') { braceCount++; started = true; }
                                if (ch === '}') braceCount--;
                            }
                            if (started && braceCount === 0) break;
                            i++;
                        }
                        
                        functions.push({ name, startLine: start + 1, endLine: i + 1, lines: funcLines });
                    }
                    i++;
                }
            } else if (currentLang === 'python') {
                const funcRegex = /^def\s+(\w+)\s*\(/;
                let i = 0;
                while (i < lines.length) {
                    const match = lines[i].match(funcRegex);
                    if (match) {
                        const name = match[1];
                        const start = i;
                        const indent = lines[i].search(/\S/);
                        let funcLines = [lines[i]];
                        i++;
                        while (i < lines.length && (lines[i].trim() === '' || lines[i].search(/\S/) > indent)) {
                            funcLines.push(lines[i]);
                            i++;
                        }
                        functions.push({ name, startLine: start + 1, endLine: i, lines: funcLines });
                        continue;
                    }
                    i++;
                }
            }
            
            return functions;
        }

        // ============================================================
        // UI UPDATES
        // ============================================================
        function updateUI() {
            const { findings, secrets, dataflows, functions } = analysisResults;
            
            // Update nav badges
            document.getElementById('nav-findings-count').textContent = findings.length;
            document.getElementById('nav-secrets-count').textContent = secrets.length;

            // Update metrics
            const critical = findings.filter(f => f.severity === 'CRITICAL').length;
            const high = findings.filter(f => f.severity === 'HIGH').length;
            const medium = findings.filter(f => f.severity === 'MEDIUM').length;
            const low = findings.filter(f => f.severity === 'LOW').length;

            document.getElementById('metric-critical').textContent = critical;
            document.getElementById('metric-high').textContent = high;
            document.getElementById('metric-medium').textContent = medium;
            document.getElementById('metric-low').textContent = low;

            // Risk score
            const riskScore = Math.min(100, critical * 25 + high * 10 + medium * 3 + low + secrets.length * 15);
            const riskCircle = document.getElementById('risk-circle');
            const riskSubtitle = document.getElementById('risk-subtitle');
            
            riskCircle.textContent = riskScore;
            riskCircle.className = 'risk-circle ' + (riskScore >= 75 ? 'critical' : riskScore >= 50 ? 'high' : riskScore >= 25 ? 'medium' : 'low');
            riskSubtitle.textContent = `${findings.length} findings, ${secrets.length} secrets detected`;

            // OWASP breakdown
            const owaspCounts = {};
            findings.forEach(f => {
                owaspCounts[f.owasp] = (owaspCounts[f.owasp] || 0) + 1;
            });

            document.getElementById('owasp-breakdown').innerHTML = Object.entries(owaspTop10)
                .map(([id, info]) => `
                    <div class="owasp-item">
                        <div class="owasp-rank">${id.substring(1)}</div>
                        <div class="owasp-info">
                            <div class="owasp-name">${info.name}</div>
                            <div class="owasp-desc">${info.desc}</div>
                        </div>
                        <div class="owasp-count" style="color: ${owaspCounts[id] ? 'var(--error)' : 'var(--text-muted)'}">${owaspCounts[id] || 0}</div>
                    </div>
                `).join('');

            // Category breakdown
            const catCounts = {};
            findings.forEach(f => {
                const cat = f.gate.split('-')[0];
                catCounts[cat] = (catCounts[cat] || 0) + 1;
            });

            document.getElementById('category-breakdown').innerHTML = Object.entries(catCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, count]) => `
                    <div style="display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid var(--border);">
                        <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;">${cat}</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);">${count}</span>
                    </div>
                `).join('') || '<div class="empty-state">No categories</div>';

            // Findings list
            renderFindings(findings);

            // Secrets list
            document.getElementById('secrets-list').innerHTML = secrets.length ? secrets.map(s => `
                <div class="secret-item">
                    <div class="secret-icon">üîë</div>
                    <div class="secret-info">
                        <div class="secret-type">${s.type}</div>
                        <div class="secret-location">Line ${s.line}</div>
                    </div>
                    <div class="secret-preview">${escapeHtml(s.preview)}</div>
                    <span class="finding-severity ${s.severity.toLowerCase()}">${s.severity}</span>
                </div>
            `).join('') : '<div class="empty-state"><div class="empty-icon">üîê</div><div>No secrets detected</div></div>';

            // Data flow list
            document.getElementById('dataflow-list').innerHTML = dataflows.length ? dataflows.map(df => `
                <div class="dataflow-container">
                    <div class="dataflow-path">
                        <div class="dataflow-node tainted">SOURCE: ${escapeHtml(df.source.type)} (L${df.source.line})</div>
                        <span class="dataflow-arrow">‚Üí</span>
                        <div class="dataflow-node tainted">SINK: ${escapeHtml(df.sink.type)} (L${df.sink.line})</div>
                    </div>
                    <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Untrusted data flows from line ${df.source.line} to dangerous sink at line ${df.sink.line}
                    </div>
                </div>
            `).join('') : '<div class="empty-state"><div class="empty-icon">üîÄ</div><div>No tainted data flows detected</div></div>';

            // Functions panel
            document.getElementById('func-count').textContent = `${functions.length} functions`;
            document.getElementById('functions-panel').innerHTML = functions.length ? functions.map((f, idx) => {
                const funcFindings = findings.filter(fd => fd.line >= f.startLine && fd.line <= f.endLine);
                const hasCritical = funcFindings.some(fd => fd.severity === 'CRITICAL');
                const hasHigh = funcFindings.some(fd => fd.severity === 'HIGH');
                
                return `
                    <div class="func-block" data-idx="${idx}">
                        <div class="func-header" onclick="toggleFunc(${idx})">
                            <div class="func-name">${escapeHtml(f.name)}</div>
                            <div class="func-badges">
                                ${hasCritical ? '<span class="func-badge" style="background: var(--critical); color: white;">CRIT</span>' : ''}
                                ${hasHigh && !hasCritical ? '<span class="func-badge" style="background: var(--error); color: white;">HIGH</span>' : ''}
                                ${!hasCritical && !hasHigh && funcFindings.length ? '<span class="func-badge" style="background: var(--warning); color: black;">WARN</span>' : ''}
                                ${!funcFindings.length ? '<span class="func-badge" style="background: var(--success); color: black;">OK</span>' : ''}
                                <span style="font-size: 0.55rem; color: var(--text-muted);">L${f.startLine}-${f.endLine}</span>
                            </div>
                        </div>
                        <div class="func-body">
                            <div class="func-code">${f.lines.map((line, i) => {
                                const lineNum = f.startLine + i;
                                const hasFinding = funcFindings.some(fd => fd.line === lineNum);
                                return `<div class="code-line ${hasFinding ? 'line-finding' : ''}"><span class="line-num">${lineNum}</span><span class="line-content">${escapeHtml(line)}</span></div>`;
                            }).join('')}</div>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="empty-state"><div class="empty-icon">üìÅ</div><div>No functions detected</div></div>';
        }

        function renderFindings(findings, filter = 'all') {
            const filtered = filter === 'all' ? findings : findings.filter(f => f.severity.toLowerCase() === filter);
            
            document.getElementById('findings-list').innerHTML = filtered.length ? filtered.map(f => `
                <div class="finding-item" onclick="this.classList.toggle('expanded')">
                    <div class="finding-header">
                        <span class="finding-severity ${f.severity.toLowerCase()}">${f.severity}</span>
                        <span class="finding-title">${f.desc}</span>
                        <span class="finding-gate">${f.gate}</span>
                        <span class="finding-meta">Line ${f.line}</span>
                    </div>
                    <div class="finding-body">
                        <div class="finding-code">${escapeHtml(f.code)}</div>
                        <div class="finding-tags">
                            <span class="tag cwe">${f.cwe}</span>
                            <span class="tag owasp">OWASP ${f.owasp}</span>
                            <span class="tag nist">NIST ${f.nist}</span>
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.7rem; color: var(--text-secondary);">
                            <strong>Remediation:</strong> ${getRemediation(f.gate)}
                        </div>
                    </div>
                </div>
            `).join('') : '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>No findings</div></div>';
        }

        function filterFindings(severity) {
            document.querySelectorAll('.tab-bar .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderFindings(analysisResults.findings, severity);
        }

        function getRemediation(gate) {
            const rems = {
                'UAF-001': 'Set pointer to NULL after free. Use RAII patterns or smart pointers.',
                'BOF-002': 'Add bounds checking before array access. Use safe functions like strncpy.',
                'INJ-001': 'Never use eval() with user input. Use ast.literal_eval() for safe parsing.',
                'INJ-003': 'Use parameterized queries instead of string formatting.',
                'SEC-001': 'Store secrets in environment variables or a secrets manager.',
                'TF-001': 'Set acl = "private" and use bucket policies for access control.',
                'K8S-001': 'Set privileged: false and use securityContext constraints.'
            };
            return rems[gate] || 'Review and apply security best practices.';
        }

        // ============================================================
        // EXPORT
        // ============================================================
        function exportSARIF() {
            const sarif = {
                "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
                "version": "2.1.0",
                "runs": [{
                    "tool": { "driver": { "name": "Euman Security Scanner", "version": "3.0" } },
                    "results": analysisResults.findings.map(f => ({
                        "ruleId": f.gate,
                        "level": f.severity === 'CRITICAL' ? 'error' : f.severity === 'HIGH' ? 'error' : 'warning',
                        "message": { "text": f.desc },
                        "locations": [{ "physicalLocation": { "region": { "startLine": f.line } } }]
                    }))
                }]
            };
            download('euman-scan.sarif', JSON.stringify(sarif, null, 2));
        }

        function exportJSON() {
            download('euman-scan.json', JSON.stringify(analysisResults, null, 2));
        }

        function download(filename, content) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================================
        // UTILITIES
        // ============================================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function pasteCode() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('code-input').value = text;
            } catch (e) {
                alert('Paste manually (Ctrl+V)');
            }
        }

        function clearCode() {
            document.getElementById('code-input').value = '';
        }

        function toggleFunc(idx) {
            document.querySelector(`.func-block[data-idx="${idx}"]`).classList.toggle('expanded');
        }

        function updateCommand() {
            const auth = document.getElementById('auth-select').value;
            const domain = document.getElementById('domain-select').value;
            const op = document.getElementById('op-select').value;
            const gate = document.getElementById('gate-select').value;
            
            let cmd = `<span style="color: #f472b6;">{${auth}}</span>`;
            cmd += `<span style="color: #60a5fa;">::${domain}</span>`;
            cmd += `<span style="color: #4ade80;">(${op})</span>`;
            if (gate) cmd += `<span style="color: #fbbf24;">[${gate}]</span>`;
            
            document.getElementById('command-preview').innerHTML = cmd;
        }

        function copyCommand() {
            const text = document.getElementById('command-preview').textContent;
            navigator.clipboard.writeText(text);
        }

        function loadQuick(type) {
            const cmds = {
                uaf: { auth: 'AI', domain: 'memory', op: 'FIX', gate: 'UAF-001' },
                bounds: { auth: 'AI', domain: 'bounds', op: 'PROTECT', gate: 'BOF-002' },
                sql: { auth: 'AI', domain: 'injection', op: 'FIX', gate: 'INJ-003' },
                secrets: { auth: 'SYSTEM', domain: 'security', op: 'DENY', gate: 'SEC-001' }
            };
            const c = cmds[type];
            document.getElementById('auth-select').value = c.auth;
            document.getElementById('domain-select').value = c.domain;
            document.getElementById('op-select').value = c.op;
            document.getElementById('gate-select').value = c.gate;
            updateCommand();
        }

        // Initialize reference
        function initReference() {
            document.getElementById('c-gates-ref').innerHTML = Object.entries(gates.c).map(([id, g]) => `
                <div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);">${id}</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">${g.desc} (${g.cwe})</div>
                </div>
            `).join('');

            document.getElementById('py-gates-ref').innerHTML = Object.entries(gates.python).map(([id, g]) => `
                <div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);">${id}</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">${g.desc} (${g.cwe})</div>
                </div>
            `).join('');

            document.getElementById('iac-gates-ref').innerHTML = [
                ...Object.entries(gates.terraform),
                ...Object.entries(gates.kubernetes),
                ...Object.entries(gates.docker)
            ].map(([id, g]) => `
                <div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);">${id}</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">${g.desc} (${g.cwe})</div>
                </div>
            `).join('');
        }

        // Init
        document.addEventListener('DOMContentLoaded', initReference);
    </script>
</body>
</html>
